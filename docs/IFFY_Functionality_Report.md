# IFFY — Current Functionality Report
_Generated 2026-02-12_

---

## 1. Product Summary

IFFY is a **living-dossier intelligence platform for independent film and TV producers**. It covers the full project lifecycle — from concept ideation and trend research through script development, packaging, budgeting, financing, production monitoring, post-production, and sales/delivery. The primary workflow: a producer creates a Project Dossier, uploads or generates scripts, runs AI-powered coverage and analysis, tracks market trends, packages talent, manages budgets and deadlines, and ultimately moves projects through stage-gates toward financing and distribution. The platform uses AI (Gemini 2.5 Flash/Pro via Lovable AI, plus Perplexity for research) to score viability, generate pitch materials, analyse scripts, and surface market intelligence.

---

## 2. Navigation Map

| Route | Description | Key Actions |
|---|---|---|
| `/` | Landing / marketing page | Sign up, learn about product |
| `/auth` | Authentication (login/signup) | Email sign-in, password reset |
| `/dashboard` | Main dashboard | Activity feed, countdowns, analytics, scores |
| `/pipeline` | Pipeline board | Kanban-style project stages, drag between stages |
| `/projects/new` | New project creation | Form to create project dossier |
| `/projects/:id` | Project detail | Tabbed view: Overview, Script, Budget, Packaging, Schedule, Documents, etc. |
| `/pitch-ideas` | Greenlight Radar | AI-generated pitch ideas, concept expansion, stress testing, concept lock |
| `/trends` | Story/narrative trends | Trend signals by production type, filters |
| `/cast-trends` | Cast/talent trends | Actor trend cards with market alignment |
| `/market-intelligence` | Market intelligence | Buyer research, market signals |
| `/buyer-crm` | Buyer CRM | Contact management, meetings, deal tracking |
| `/incentive-finder` | Incentive programs | Tax credits, rebates by jurisdiction |
| `/copro-planner` | Co-production planner | Framework matching, partner research |
| `/festival-calendar` | Festival calendar | Festival dates, deadlines, submissions |
| `/production-calendar` | Production calendar | Schedule management |
| `/stack-cashflow` | Stack cashflow | Multi-project cashflow modeling |
| `/coverage-lab` | Coverage Lab | Script coverage runs, prompt versions, benchmarks |
| `/story-trends` | Story trends detail | Narrative trend deep-dive |
| `/trend-governance` | Trend governance | Engine weights, model accuracy, calibration |
| `/compare` | Compare projects | Side-by-side project comparison |
| `/reports` | Reports | Cross-project analytics |
| `/notifications` | Notifications | Activity notifications |
| `/settings` | Settings | User preferences, company, subscription |
| `/companies` | Companies | Production company management |
| `/companies/:id` | Company detail | Members, projects, settings |
| `/presentation` | Presentation mode | Investor/pitch presentation view |
| `/pricing` | Pricing page | Subscription tiers |
| `/about` | About page | Product information |
| `/how-it-works` | How it works | Feature walkthrough |
| `/faq` | FAQ | Common questions |

---

## 3. Core Modules

### 3.1 Project Dossiers
- **Inputs**: Title, logline, genre, subgenre, production type, format subtype, budget band, region, status, platform target
- **Outputs**: Stored project record with auto-assigned monetisation lane, viability scores, readiness scores
- **UI**: `/projects/new` (creation), `/projects/:id` (detail with tabbed interface)
- **Definition of Done**: Project saved to `projects` table, lane classifier runs, scores computed

### 3.2 Document Upload & Analysis
- **Inputs**: PDF/text file uploads (scripts, budgets, contracts, schedules)
- **Outputs**: Extracted text stored in `project_documents`, AI analysis results
- **UI**: Documents tab on project detail, `AddDocumentsUpload` component
- **Definition of Done**: File uploaded to storage, document record created, extraction edge function completes

### 3.3 Script Coverage (Uploaded Scripts)
- **Inputs**: Uploaded script (PDF), project metadata, production type, format profile
- **Outputs**: 3-pass coverage (Analyst → Producer → QC), structured notes with categories, metrics (scores for structure, dialogue, character, etc.)
- **UI**: Coverage Lab (`/coverage-lab`), coverage tab on project detail
- **Definition of Done**: `coverage_runs` record created with `pass_a`, `pass_b`, `pass_c`, `final_coverage`, `structured_notes`, `metrics` populated
- **Note**: Uses `coverage_prompt_versions` for versioned prompts; supports benchmarking via `coverage_benchmarks`

### 3.4 Self-Coverage (IFFY-Written Scripts)
- **Inputs**: Script generated by Script Engine
- **Outputs**: Same 3-pass coverage as uploaded scripts
- **UI**: Same Coverage Lab interface
- **Definition of Done**: Coverage run completes on IFFY-generated script with all passes populated

### 3.5 Monetisation Lanes + Scoring
- **Inputs**: Project metadata (genre, budget, production type, region)
- **Outputs**: Lane classification (one of ~7 lanes: Studio Tentpole, Premium Independent, Festival Circuit, etc.), confidence score, viability score
- **Logic**: `src/lib/lane-classifier.ts`, `src/lib/master-viability.ts`
- **UI**: Project detail overview, pipeline board
- **Definition of Done**: Lane assigned with confidence > 0, viability score computed

### 3.6 Trend Engine
- **Inputs**: Production type filter, genre, region
- **Outputs**: Trend signals with strength, velocity, forecast, saturation risk
- **UI**: `/trends`, `/story-trends`, trend layer in project detail
- **Tables**: `trends` (263 signals currently), `trend_engines` (22 engines), `data_sources` (currently empty — defaults used)
- **Definition of Done**: Trends displayed, filterable by production type
- **Note**: Refresh is manual via `refresh-trends` edge function. `data_sources` table is empty — engine confidence uses hardcoded 0.8 default

### 3.7 Cast/Talent Trends
- **Inputs**: Actor data with genre relevance, budget tier, region
- **Outputs**: Trend cards with cycle phase, velocity, market alignment, sales leverage
- **UI**: `/cast-trends`, `CastTrendCard` component
- **Table**: `cast_trends` (263 records currently)
- **Definition of Done**: Cast trends displayed with filtering

### 3.8 Pitch Ideas / Greenlight Radar
- **Inputs**: Development brief (genre, production type, budget band, region, risk appetite), or manual creation
- **Outputs**: AI-generated pitch ideas with title, logline, one-page pitch, comps, packaging suggestions, development sprint, risks/mitigations, scores (market heat, feasibility, lane fit, saturation risk, company fit)
- **UI**: `/pitch-ideas`, `PitchIdeaCard` component
- **Table**: `pitch_ideas` (9 records currently)
- **Definition of Done**: Pitch idea generated and saved with all score fields populated

### 3.9 Concept Lock System
- **Inputs**: Pitch idea + concept expansion + stress test
- **Outputs**: Locked concept version with immutable snapshot of fields
- **Flow**: Expand Concept → Stress Test → Lock
- **Tables**: `concept_expansions`, `concept_stress_tests`, `concept_lock_versions`
- **UI**: `ConceptLockPanel` within `PitchIdeaCard`
- **Definition of Done**: `concept_lock_status` = "locked", `concept_lock_versions` record created with `locked_fields` snapshot

### 3.10 Promote Locked Idea → Project
- **Inputs**: Locked pitch idea
- **Outputs**: New project created from idea metadata, concept lock documents copied
- **Edge Function**: `promote-locked-idea`
- **Tables**: `concept_lock_documents`, links `pitch_ideas.promoted_to_project_id`
- **UI**: "Promote to Project" button on locked ideas
- **Definition of Done**: New project created, `promoted_to_project_id` set, concept docs transferred

### 3.11 Budget Scaffold
- **Inputs**: Project metadata, budget assumptions (shoot days, locations, cast level, VFX level, union level)
- **Outputs**: Budget assumptions record, estimated total, cost tracking entries
- **Tables**: `budget_assumptions`, `cost_entries`
- **UI**: Budget tab on project detail, `BudgetPanel`, `BudgetAssumptionsPanel`
- **Definition of Done**: Budget assumptions saved with estimated total

### 3.12 Packaging Pipeline
- **Inputs**: Project, packaging items (cast, director, producer, etc.)
- **Outputs**: Packaging items with status, priority, archetype
- **Table**: `packaging_items`
- **UI**: Packaging tab on project detail, `PackagingPipelinePanel`
- **Definition of Done**: Packaging items created and trackable

### 3.13 Stage-Gates / Pipeline Board
- **Inputs**: Projects with pipeline stages
- **Outputs**: Kanban board view of projects across lifecycle stages
- **UI**: `/pipeline`, `StageGatesPanel` on project detail
- **Stages**: Development → Packaging → Pre-Production → Production → Post-Production → Sales & Delivery
- **Definition of Done**: Projects moveable between stages

### 3.14 Script Engine
- **Inputs**: Project metadata, format profile, optional corpus calibration
- **Outputs**: Blueprint → Architecture → Batch-drafted scenes → Assembled script
- **Edge Functions**: `script-engine` (multi-step: blueprint, architecture, batch, assemble, rewrite)
- **Tables**: `scripts`, `script_versions`, `script_scenes`
- **UI**: Script tab on project detail, `ScriptEnginePanel`
- **Definition of Done**: Full script generated with all scenes, stored as version
- **Reliability**: Uncertain — batch drafting may timeout or produce incomplete output on longer scripts

### 3.15 Rewrite Engine
- **Inputs**: Existing script version, rewrite goal, intensity, playbooks
- **Outputs**: New script version with tracked changes, score deltas
- **Table**: `improvement_runs`
- **UI**: Script Engine panel rewrite mode
- **Definition of Done**: New version created, regression check passes

### 3.16 Export System
- **Inputs**: Project data, script content, coverage results
- **Outputs**: PDF export (via jspdf), CSV/XLS export (via xlsx), ICS calendar export
- **Libraries**: `jspdf`, `jspdf-autotable`, `xlsx`
- **Files**: `src/lib/pdf-export.ts`, `src/lib/csv-export.ts`, `src/lib/xls-export.ts`, `src/lib/ics-export.ts`
- **UI**: Export buttons throughout project detail
- **Limitations**: No FDX (Final Draft) export. All exports are client-side generated.

### 3.17 Corpus Ingestion
- **Inputs**: Approved source URLs (IMSDB scripts)
- **Outputs**: Parsed scripts with structural analysis, scene patterns, character profiles, corpus insights
- **Tables**: `approved_sources`, `corpus_scripts` (98 ingested), `corpus_chunks`, `corpus_scenes`, `corpus_scene_patterns`, `corpus_character_profiles`, `corpus_derived_artifacts`, `corpus_insights`
- **Edge Function**: `ingest-corpus`, `analyze-corpus`
- **UI**: `CorpusLibrary`, `CorpusInsightsDashboard`
- **Definition of Done**: Scripts ingested with structural metrics populated
- **Note**: 6 scripts marked UNAVAILABLE (404 on IMSDB). Embeddings column exists in `corpus_chunks` but is not currently used for vector search.

---

## 4. Data Sources & Trend Engines

### Trend Engines (22 active)
Organized into 4 layers:
- **Market Layer**: Box Office, Streaming Performance, Festival Circuit, International Sales, Award Season
- **Narrative Layer**: Genre Evolution, Thematic Emergence, Structural Innovation, Audience Sentiment
- **Talent Layer**: Director Momentum, Actor Market Value, Writer Voice, Emerging Talent
- **Platform Layer**: Platform Commissioning, Format Innovation, Regional Content, IP Adaptation, Cross-Media

### Data Sources
- **`data_sources` table is currently EMPTY**
- Engine confidence defaults to hardcoded 0.8
- Trend signals come from `refresh-trends` edge function using Perplexity API for real-time research
- **This is a gap**: no formal data source registry is populated

---

## 5. Database Schema (Key Tables)

| Table | Purpose | Key Relationships |
|---|---|---|
| `projects` | Core project dossiers | Referenced by most tables |
| `scripts` | Script files | FK → projects |
| `script_versions` | Versioned script content | FK → scripts |
| `script_scenes` | Individual scenes | FK → script_versions |
| `coverage_runs` | Coverage analysis results | FK → projects, scripts, prompt_versions |
| `coverage_prompt_versions` | Versioned coverage prompts | Referenced by coverage_runs |
| `coverage_feedback` | User feedback on coverage | FK → coverage_runs |
| `coverage_feedback_notes` | Per-note feedback | FK → coverage_runs |
| `coverage_benchmarks` | Gold-standard test cases | FK → scripts |
| `trends` | Story/narrative trend signals | Standalone |
| `cast_trends` | Actor/talent trends | Standalone |
| `trend_engines` | Engine definitions | Referenced by engine_source_map |
| `data_sources` | Source registry (EMPTY) | Referenced by engine_source_map |
| `pitch_ideas` | AI-generated concepts | FK → projects, briefs |
| `concept_expansions` | Expanded concept docs | FK → pitch_ideas |
| `concept_stress_tests` | Stress test results | FK → concept_expansions |
| `concept_lock_versions` | Locked concept snapshots | FK → pitch_ideas, expansions, stress_tests |
| `concept_lock_documents` | Docs for locked concepts | FK → pitch_ideas, projects |
| `budget_assumptions` | Budget parameters | FK → projects |
| `cost_entries` | Actual cost tracking | FK → projects |
| `packaging_items` | Cast/crew packaging | FK → projects |
| `buyer_contacts` | Buyer CRM contacts | Standalone |
| `buyer_meetings` | Meeting records | FK → buyer_contacts, projects |
| `market_buyers` | Market buyer database | Standalone |
| `incentive_programs` | Tax incentives | Standalone |
| `copro_frameworks` | Co-production treaties | Standalone |
| `corpus_scripts` | Ingested reference scripts | FK → approved_sources |
| `corpus_chunks` | Text chunks (embeddings col unused) | FK → corpus_scripts |
| `corpus_insights` | Aggregated patterns | Standalone |
| `notifications` | User notifications | FK → projects |
| `production_companies` | Company records | Referenced by company_members |
| `company_members` | Team members | FK → production_companies |
| `format_profiles` | Format calibration | FK → projects |
| `improvement_runs` | Rewrite tracking | FK → projects, script_versions |

### Storage Buckets
- `scripts` — uploaded script files
- `project-documents` — uploaded project documents

### RLS
- Most tables use `auth.uid() = user_id` policies
- Project access uses `has_project_access` helper function for team/company sharing
- Coverage tables check `created_by = auth.uid()`

---

## 6. AI Architecture

### Models Used
| Model | Where Used |
|---|---|
| `google/gemini-2.5-flash` | Script coverage, script engine, pitch generation, concept expansion, stress testing, corpus analysis |
| `google/gemini-2.5-flash-lite` | Lighter analysis tasks, note analysis |
| Perplexity API (`llama-3.1-sonar-huge-128k-online`) | Trend research, buyer research, incentive research, person research, co-pro research |

### Prompting Approach
- **Coverage**: 3-pass chain (Analyst → Producer → QC merge)
- **Script Engine**: Multi-step pipeline (Blueprint → Architecture → Batch scenes → Assembly → optional Rewrite)
- **Pitch Generation**: Single-pass with structured JSON output
- **Concept Expansion**: Single-pass generating treatment, character bible, tone doc, arc map, world bible

### Scoring
- Coverage: metrics JSON with structure, dialogue, character, pacing scores (0-100)
- Viability: composite from lane fit, market heat, feasibility, saturation risk
- Readiness: stage-based readiness scores computed client-side

### Embeddings/Vector Search
- `corpus_chunks.embedding` column exists (type `vector`) but is **NOT currently populated or queried**
- `corpus_chunks.search_vector` exists for full-text search (tsvector)
- No active RAG/retrieval pipeline

---

## 7. Versioning & Immutability

- **Scripts**: Versioned via `script_versions` table. Each edit creates a new version.
- **Concept Locks**: Immutable once locked. Unlock requires explicit reason (`unlock_reason`). Version number increments.
- **Coverage**: Each run is a separate record. Not editable after creation.
- **Budget Assumptions**: Versioned (`version` column). New version created on major changes.
- **Coverage Prompts**: Versioned via `coverage_prompt_versions` with status (draft/active/archived)

---

## 8. Permissions & Roles

- **Auth**: Email/password via Lovable Cloud auth. No social login currently.
- **Roles**: `company_members.default_role` supports roles but enforcement is minimal in UI
- **Project Access**: `has_project_access` DB function checks ownership + company membership
- **Coverage Lab**: Appears to have admin-oriented features but no strict role gating in UI
- **Gaps**: No formal admin vs. writer distinction enforced in frontend. Company member invites exist but role-based feature gating is incomplete.

---

## 9. Export / Interoperability

| Format | Method | Status |
|---|---|---|
| PDF | `jspdf` + `jspdf-autotable` (client-side) | Working |
| CSV | `xlsx` library (client-side) | Working |
| XLS | `xlsx` library (client-side) | Working |
| ICS | Custom generator (client-side) | Working |
| FDX | Not implemented | Missing |
| Movie Magic Import | UI component exists (`MovieMagicImport`) | Uncertain functionality |

---

## 10. Reliability Notes

- **Script Engine batch drafting**: May timeout on longer scripts; reliability uncertain for full-length features
- **Trend refresh**: Manual only; no automated scheduling
- **Corpus ingestion**: 6/104 scripts failed (IMSDB 404s), now marked UNAVAILABLE with retry logic
- **Edge function timeouts**: Long-running AI calls (script engine, coverage) may hit timeout limits
- **Console warning**: `ConceptLockPanel` passes ref to `Badge` component incorrectly (non-critical)
- **Data sources table empty**: Trend engine confidence scores use hardcoded defaults
- **Error handling**: Edge functions return structured JSON errors; UI shows toast notifications via sonner

---

## 11. Not Yet Implemented

- FDX (Final Draft) export
- Automated trend refresh scheduling (CRON)
- Vector/semantic search on corpus chunks (embedding column unused)
- Formal role-based access control in UI
- Stripe billing integration (webhook exists but not connected to UI gating)
- Multi-user real-time collaboration (Supabase realtime not actively used)
- Mobile-responsive optimization (desktop-first)
- Automated corpus calibration feedback loop to Script Engine
- Deep analytics/reporting dashboard beyond basic charts
- Email notifications (notification system is in-app only)

---

## 12. Recommended Next 10 Improvements

| # | Improvement | Impact | Effort | Dependencies |
|---|---|---|---|---|
| 1 | Populate `data_sources` + wire to engine confidence | High | Low | None |
| 2 | Automated trend refresh (scheduled CRON) | High | Medium | Edge function scheduling |
| 3 | FDX export for scripts | Medium | Medium | FDX format spec |
| 4 | Activate corpus embeddings + RAG retrieval | High | High | Vector search setup |
| 5 | Script Engine reliability (chunking, timeout handling) | High | Medium | Edge function optimization |
| 6 | Role-based UI gating (admin/writer/viewer) | Medium | Medium | Auth + company_members |
| 7 | Stripe subscription enforcement | Medium | Medium | Stripe webhook completion |
| 8 | Corpus → Script Engine calibration loop | High | High | Corpus insights + format profiles |
| 9 | Real-time collaboration on projects | Medium | High | Supabase realtime |
| 10 | Email/push notifications | Low | Medium | Email provider integration |

---

## Verification Checklist (Top 5)

1. ✅ Create a new project dossier → verify lane classification + scores appear
2. ✅ Generate a pitch idea from Greenlight Radar → verify all fields populated
3. ✅ Expand concept → stress test → lock → verify immutability
4. ✅ Upload a script → run coverage → verify 3-pass output
5. ✅ Check `/trends` page → verify trend signals display with filters

## Top 5 Questions for Team

1. **What is the expected trend refresh cadence?** Currently manual — should there be daily/weekly automation?
2. **Are all 22 trend engines producing useful differentiation?** Or should some be consolidated?
3. **Is Script Engine reliably completing full-length drafts?** What's the failure mode?
4. **What real data sources should populate `data_sources`?** The table is empty.
5. **Is Stripe billing a launch priority?** Infrastructure exists but isn't enforced.
